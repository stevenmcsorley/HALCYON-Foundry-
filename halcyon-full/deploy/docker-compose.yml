version: "3.9"
services:
  postgres:
    image: postgres:16
    environment:
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-dev}
      POSTGRES_DB: halcyon
    ports: [ "5432:5432" ]
    volumes: [ "pg:/var/lib/postgresql/data" ]

  neo4j:
    image: neo4j:5
    environment:
      NEO4J_AUTH: ${NEO4J_AUTH:-neo4j/devpassword123}
      NEO4J_dbms_security_auth__minimum__password__length: 3
    ports: [ "7474:7474", "7687:7687" ]
    volumes: [ "neo4j:/data" ]

  ontology:
    build: ../core/ontology
    command: uvicorn app.main:create_app --factory --host 0.0.0.0 --port 8081
    environment:
      APP_PORT: 8081
      PG_DSN: postgresql://postgres:${POSTGRES_PASSWORD:-dev}@postgres:5432/halcyon
      NEO4J_URI: bolt://neo4j:7687
      NEO4J_USER: neo4j
      NEO4J_PASS: ${NEO4J_PASS:-devpassword123}
    depends_on: [ postgres, neo4j ]
    ports: [ "8081:8081" ]

  gateway:
    build: ../core/gateway
    command: uvicorn app.main:create_app --factory --host 0.0.0.0 --port 8088
    environment:
      APP_PORT: 8088
      ONTOLOGY_BASE_URL: http://ontology:8081
      POLICY_BASE_URL: http://opa:8181/v1/data/halcyon/allow
    depends_on: [ ontology, opa ]
    ports: [ "8088:8088" ]

  registry:
    build: ../core/registry
    command: uvicorn app.main:app --host 0.0.0.0 --port 8090
    environment:
      DATASOURCES_DIR: /app/datasources
      ONTOLOGY_BASE_URL: http://ontology:8081
    volumes:
      - ../datasources:/app/datasources:ro
    depends_on: [ ontology ]
    ports: [ "8090:8090" ]

  enrichment:
    build: ../core/enrichment
    command: uvicorn app.main:app --host 0.0.0.0 --port 8091
    environment:
      ONTOLOGY_BASE_URL: http://ontology:8081
    depends_on: [ ontology ]
    ports: [ "8091:8091" ]

  # OPA serving policies from local bundle
  opa:
    image: openpolicyagent/opa:latest
    command: ["run", "--server", "--addr", ":8181", "--set", "bundles.halcyon.service=local", "--set", "services.local.url=file:///bundles"]
    volumes:
      - ../core/policy/bundle:/bundles:ro
    ports: [ "8181:8181" ]

  ui:
    build: ../ui
    environment:
      VITE_GATEWAY_URL: ${VITE_GATEWAY_URL:-http://localhost:8088/graphql}
    command: ["sh", "-c", "npm install && npm run dev -- --host 0.0.0.0"]
    ports: [ "5173:5173" ]
    volumes:
      - ../ui:/usr/src/app
    depends_on: [ gateway ]

volumes:
  pg: {}
  neo4j: {}

version: "3.9"
services:
  postgres:
    image: postgres:16
    environment:
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-dev}
      POSTGRES_DB: halcyon
    ports: [ "5432:5432" ]
    volumes: [ "pg:/var/lib/postgresql/data" ]

  neo4j:
    image: neo4j:5
    environment:
      NEO4J_AUTH: ${NEO4J_AUTH:-neo4j/devpassword123}
      NEO4J_dbms_security_auth__minimum__password__length: 3
    ports: [ "7474:7474", "7687:7687" ]
    volumes: [ "neo4j:/data" ]

  redis:
    image: redis:7-alpine
    ports: [ "6379:6379" ]
    volumes: [ "redis:/data" ]

  ontology:
    build: ../core/ontology
    command: uvicorn app.main:create_app --factory --host 0.0.0.0 --port 8081
    environment:
      APP_PORT: 8081
      PG_DSN: postgresql://postgres:${POSTGRES_PASSWORD:-dev}@postgres:5432/halcyon
      NEO4J_URI: bolt://neo4j:7687
      NEO4J_USER: neo4j
      NEO4J_PASS: ${NEO4J_PASS:-devpassword123}
    depends_on: [ postgres, neo4j ]
    ports: [ "8081:8081" ]

  gateway:
    build: ../core/gateway
    command: uvicorn app.main:create_app --factory --host 0.0.0.0 --port 8088
    environment:
      APP_PORT: 8088
      ONTOLOGY_BASE_URL: http://ontology:8081
      POLICY_BASE_URL: http://opa:8181/v1/data/halcyon/allow
      REDIS_URL: redis://redis:6379/0
      KEYCLOAK_URL: ${KEYCLOAK_URL:-http://keycloak:8089}
      KEYCLOAK_REALM: ${KEYCLOAK_REALM:-halcyon-dev}
      KEYCLOAK_CLIENT_ID: ${KEYCLOAK_CLIENT_ID:-halcyon-gateway}
      JWT_ALGORITHM: ${JWT_ALGORITHM:-RS256}
      DEV_MODE: ${DEV_MODE:-false}
    depends_on: [ ontology, opa, redis ]
    ports: [ "8088:8088" ]

  registry:
    build: ../core/registry
    command: uvicorn app.main:app --host 0.0.0.0 --port 8090
    environment:
      DATASOURCES_DIR: /app/datasources
      ONTOLOGY_BASE_URL: http://ontology:8081
    volumes:
      - ../datasources:/app/datasources:ro
    depends_on: [ ontology ]
    ports: [ "8090:8090" ]

  enrichment:
    build: ../core/enrichment
    command: uvicorn app.main:app --host 0.0.0.0 --port 8091
    environment:
      ONTOLOGY_BASE_URL: http://ontology:8081
    depends_on: [ ontology ]
    ports: [ "8091:8091" ]

  # OPA serving policies from local bundle
  opa:
    image: openpolicyagent/opa:latest
    command: ["run", "--server", "--addr", ":8181", "--bundle", "/bundles"]
    volumes:
      - ../core/policy/bundle:/bundles:ro
    ports: [ "8181:8181" ]

  ui:
    build: ../ui
    environment:
      VITE_GATEWAY_URL: ${VITE_GATEWAY_URL:-http://localhost:8088/graphql}
      VITE_DEV_MODE: ${VITE_DEV_MODE:-false}
      VITE_KEYCLOAK_URL: ${VITE_KEYCLOAK_URL:-http://localhost:8089}
      VITE_KEYCLOAK_REALM: ${VITE_KEYCLOAK_REALM:-halcyon-dev}
      VITE_KEYCLOAK_CLIENT_ID: ${VITE_KEYCLOAK_CLIENT_ID:-halcyon-ui}
    command: ["sh", "-c", "npm install && npm run dev -- --host 0.0.0.0"]
    ports: [ "5173:5173" ]
    volumes:
      - ../ui:/usr/src/app
    depends_on: [ gateway ]

  prometheus:
    image: prom/prometheus:latest
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
    ports: [ "${PROMETHEUS_PORT:-9090}:9090" ]
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus:/prometheus
    depends_on: [ ontology, gateway, registry, enrichment ]

  grafana:
    image: grafana/grafana:latest
    environment:
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_ADMIN_PASSWORD:-admin}
      GF_PATHS_PROVISIONING: /etc/grafana/provisioning
    ports: [ "${GRAFANA_PORT:-3000}:3000" ]
    volumes:
      - ./grafana/datasources:/etc/grafana/provisioning/datasources:ro
      - ./grafana/dashboards:/etc/grafana/provisioning/dashboards:ro
      - grafana:/var/lib/grafana
    depends_on: [ prometheus ]

  jaeger:
    image: jaegertracing/all-in-one:latest
    environment:
      COLLECTOR_OTLP_ENABLED: true
    ports: [ "16686:16686", "4317:4317", "4318:4318" ]

  keycloak:
    image: quay.io/keycloak/keycloak:latest
    command: start-dev --import-realm
    environment:
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD: ${KEYCLOAK_ADMIN_PASSWORD:-admin}
      KC_DB: dev-mem
      KC_HOSTNAME_STRICT: false
    ports: [ "${KEYCLOAK_PORT:-8089}:8080" ]
    volumes:
      - ./keycloak/realm-export.json:/opt/keycloak/data/import/realm-export.json:ro

volumes:
  pg: {}
  neo4j: {}
  redis: {}
  prometheus: {}
  grafana: {}
